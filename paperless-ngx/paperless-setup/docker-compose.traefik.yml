# Paperless-ngx con Traefik - SSL AutomÃ¡tico
# Autor: ElDiarioIA.es
# Requiere: Red externa "traefik" existente

version: "3.8"

services:
  broker:
    image: redis:7-alpine
    container_name: paperless-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - paperless-internal

  db:
    image: postgres:15-alpine
    container_name: paperless-db
    restart: unless-stopped
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: ${PAPERLESS_DBNAME:-paperless}
      POSTGRES_USER: ${PAPERLESS_DBUSER:-paperless}
      POSTGRES_PASSWORD: ${PAPERLESS_DBPASS:-paperless}
    networks:
      - paperless-internal

  webserver:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    container_name: paperless
    restart: unless-stopped
    depends_on:
      - broker
      - db
    volumes:
      - data:/usr/src/paperless/data
      - media:/usr/src/paperless/media
      - ./consume:/usr/src/paperless/consume
      - ./export:/usr/src/paperless/export
    environment:
      PAPERLESS_DBHOST: db
      PAPERLESS_DBNAME: ${PAPERLESS_DBNAME:-paperless}
      PAPERLESS_DBUSER: ${PAPERLESS_DBUSER:-paperless}
      PAPERLESS_DBPASS: ${PAPERLESS_DBPASS:-paperless}
      PAPERLESS_REDIS: redis://broker:6379
      PAPERLESS_TIME_ZONE: ${TZ:-Europe/Madrid}
      PAPERLESS_OCR_LANGUAGE: ${PAPERLESS_OCR_LANGUAGE:-spa+eng}
      PAPERLESS_ADMIN_USER: ${PAPERLESS_ADMIN_USER:-admin}
      PAPERLESS_ADMIN_PASSWORD: ${PAPERLESS_ADMIN_PASSWORD:-changeme}
      USERMAP_UID: ${PUID:-1000}
      USERMAP_GID: ${PGID:-1000}
      # URL con HTTPS para Traefik
      PAPERLESS_URL: https://${PAPERLESS_DOMAIN:-docs.example.com}
    networks:
      - paperless-internal
      - traefik
    labels:
      # Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"
      # Router HTTP -> HTTPS
      - "traefik.http.routers.paperless.rule=Host(`${PAPERLESS_DOMAIN:-docs.example.com}`)"
      - "traefik.http.routers.paperless.entrypoints=websecure"
      - "traefik.http.routers.paperless.tls.certresolver=letsencrypt"
      # Servicio
      - "traefik.http.services.paperless.loadbalancer.server.port=8000"

networks:
  paperless-internal:
    driver: bridge
  traefik:
    external: true

volumes:
  redis_data:
  pgdata:
  data:
  media:

