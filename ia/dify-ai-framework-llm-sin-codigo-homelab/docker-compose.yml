version: '3.8'

services:
  dify-api:
    image: langgenius/dify-api:latest
    ports:
      - "5001:5001"
    environment:
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - DATABASE_URL=postgresql://dify:dify@postgres:5432/dify
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CELERY_BROKER_URL=redis://redis:6379/1
      - WEB_API_CORS_ALLOW_ORIGINS=http://localhost:3000
      - CONSOLE_API_URL=http://localhost:5001
      - SERVICE_API_URL=http://localhost:5001
      - APP_WEB_URL=http://localhost:3000
      # Configuraci√≥n Ollama (opcional)
      - OLLAMA_API_BASE_URL=http://ollama:11434
    depends_on:
      - postgres
      - redis
      - qdrant
    volumes:
      - ./storage:/app/api/storage
    restart: unless-stopped

  dify-web:
    image: langgenius/dify-web:latest
    ports:
      - "3000:3000"
    environment:
      - CONSOLE_API_URL=http://localhost:5001
      - APP_API_URL=http://localhost:5001
    depends_on:
      - dify-api
    restart: unless-stopped

  # Ollama para modelos LLM locales (opcional)
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_PASSWORD=dify
      - POSTGRES_DB=dify
      - POSTGRES_USER=dify
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
  ollama_data:

